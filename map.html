<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ·±è‰²åœ°å›¾</title>
<link rel="icon" href="data:;base64,=">
<style>
html, body, #container {
  width: 100%;
  height: 100%;
  margin: 0;
  padding: 0;
}
#captureBtn {
  position: absolute;
  bottom: 20px;
  right: 20px;
  z-index: 999;
  background: #07c160;
  color: #785151;
  border: none;
  border-radius: 30px;
  padding: 10px 20px;
  font-size: 16px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
  cursor: pointer;
}
</style>

<!-- è…¾è®¯åœ°å›¾ JS API v2 -->
<script>
  function loadMapApi() {
    const script = document.createElement('script');
    script.src = "https://map.qq.com/api/js?v=2.exp&key=OB4BZ-D4W3U-B7VVO-4PJWW-6TKDJ-WPB77&callback=initMap";
    script.async = true;
    document.body.appendChild(script);
  }
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
<div id="container"></div>
<button id="captureBtn">ğŸ“· ä¿å­˜åœ°å›¾</button>

<script>
let map = null;

// H5ä¼ å‚è§£æ
const params = new URLSearchParams(location.search);
const path = JSON.parse(decodeURIComponent(params.get('path')));

// åˆå§‹åŒ–åœ°å›¾å›è°ƒ
function initMap() {
  // åˆ›å»ºåœ°å›¾ï¼Œå…³é—­æ‰€æœ‰æ§ä»¶
  map = new qq.maps.Map(document.getElementById("container"), {
    center: new qq.maps.LatLng(path[0].lat, path[0].lng),
    zoom: 5,
    mapTypeId: qq.maps.MapTypeId.ROADMAP,
    mapStyleId: 'style2',      // å®˜æ–¹æš—è‰²æ ·å¼
    zoomControl: false,        // å…³é—­ç¼©æ”¾æŒ‰é’®
    scaleControl: false,       // å…³é—­æ¯”ä¾‹å°º
    mapTypeControl: false,     // å…³é—­å«æ˜Ÿåˆ‡æ¢
    panControl: false,         // å…³é—­å¹³ç§»æ§ä»¶
    draggable: true,           // ä¿ç•™æ‹–æ‹½æ‰‹åŠ¿
    scrollwheel: true          // ä¿ç•™æ»šè½®ç¼©æ”¾
  });

  // ç»˜åˆ¶åŸå¸‚ç‚¹
  path.forEach(p => {
    new qq.maps.Marker({
      position: new qq.maps.LatLng(p.lat, p.lng),
      map: map,
      title: p.city
    });
  });

  document.getElementById("captureBtn").addEventListener("click", async () => {
  try {
    const canvas = await html2canvas(document.querySelector("#container"), {
      useCORS: true,
      scale: 2
    });
    const imgData = canvas.toDataURL("image/png");
    console.log("âœ… html2canvas æˆªå›¾å®Œæˆï¼Œbase64 é•¿åº¦:", imgData.length);

    // ç›´æ¥åœ¨æµè§ˆå™¨è§¦å‘ä¸‹è½½
    const link = document.createElement("a");
    link.href = imgData;
    link.download = "map-screenshot.png";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    console.log("âœ… å·²è§¦å‘æµè§ˆå™¨ä¸‹è½½");
  } catch (err) {
    console.error("âŒ æˆªå›¾å¤±è´¥:", err);
  }
});

}

// å¼€å§‹åŠ è½½åœ°å›¾API
loadMapApi();
</script>
</body>
</html>

